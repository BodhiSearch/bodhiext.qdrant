name: Bodhilib plugin for Qdrant Vector DB CI/CD
on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - v*
  workflow_dispatch:
    branches:
      - main
    inputs:
      release:
        description: 'Publish a release (yes) or pre-release (pre) or none (no)? (yes/pre/no)'
        required: false
        default: 'no'

jobs:
  prepare: # This job is for preparing the environment and caching it to speed up later jobs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python with Poetry
        uses: './.github/actions/setup'
        with:
          setup-only: 'true'

  pre-commit:
    needs: [prepare]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python with Poetry
        uses: './.github/actions/setup'
      - name: Check poetry files
        shell: bash
        run: |
          make check
      - name: Pre-commit
        uses: pre-commit/action@v3.0.0

  test:
    needs: [prepare]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python with Poetry
        uses: './.github/actions/setup'
      - name: Copy .env.ci to .env.test
        run: cp .env.ci .env.test
      - name: Run tests
        run: make test
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage
          path: htmlcov

  prerelease:
    needs: [pre-commit, test]
    if: github.event.inputs.release == 'pre'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python with Poetry
        uses: './.github/actions/setup'
      - name: Get current version
        id: current-version
        run: |
          echo "CURRENT_VERSION=$(poetry version --short)" >> $GITHUB_ENV
      - name: Set new pre-release version
        id: new-version
        run: |
          echo "NEW_VERSION=${{ env.CURRENT_VERSION }}-$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
      - name: Update version to pre-release version
        run: |
          poetry version "${{ env.NEW_VERSION }}"
          VERSION_FILE=$(find src -name '_version.py')
          echo "__version__ = \"${{ env.NEW_VERSION }}\"" >> "${VERSION_FILE}"
      - name: Build package
        run: make build
      - name: Create pre-release
        uses: ncipollo/release-action@v1
        with:
          artifacts: 'dist/*'
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ env.NEW_VERSION }}
          prerelease: true

  release:
    needs: [pre-commit, test]
    if: github.event.inputs.release == 'yes'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python with Poetry
        uses: './.github/actions/setup'
      - name: Get current version
        id: current-version
        run: |
          echo "CURRENT_VERSION=$(poetry version --short)" >> $GITHUB_ENV
      - name: Build package
        run: make build
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: 'dist/*'
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ env.CURRENT_VERSION }}
          commit: main
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          print-hash: true
      - name: Bump patch version
        run: |
          IFS='.' read -ra ADDR <<< "$CURRENT_VERSION"
          new_patch=$(( ${ADDR[2]} + 1 ))
          NEW_VERSION="${ADDR[0]}.${ADDR[1]}.$new_patch"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
      - name: Update poetry and _version.py
        run: |
          poetry version "$NEW_VERSION"
          VERSION_FILE=$(find src -name '_version.py')
          # Overwrite the _version.py file with the new version
          echo "# this file is automatically generated and overwritten by CI process" > "${VERSION_FILE}"
          echo "# to modify the content, modify the CI workflow file - .github/workflows/main.yml, job: \"Bump patch version\"" >> "${VERSION_FILE}"
          echo "__version__ = \"$NEW_VERSION\"" >> "${VERSION_FILE}"
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<github-actions@users.noreply.github.com>"
          git add pyproject.toml
          git add "${VERSION_FILE}"

          git commit -m "[Github Workflows] bumping up the patch version to ${NEW_VERSION} for Bodhilib plugin for Qdrant Vector DB"
          git push
